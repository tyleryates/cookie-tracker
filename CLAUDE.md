# CLAUDE.md

## CRITICAL: NEVER Auto-Commit or Auto-Publish

NEVER create git commits, push, build, or publish without explicit user request. User wants full control over git history and release timing.

## Accessibility

This is a small internal tool — do NOT add full WCAG/accessibility support (error boundaries, focus trapping, ARIA roles, screen-reader-only elements, etc.). Simple attributes like `aria-label` on buttons are fine, but avoid adding code complexity for accessibility.

## Working in This Repo

- Edit `.ts`/`.tsx` files in `src/`, NEVER `.js` files in `dist/` (auto-generated by build)
- `make` to see all available commands
- `make dev` to compile and run the app
- `make compile` to compile without running
- `make format` to auto-format (biome)
- `make lint` to check formatting/lint without changes
- `make typecheck` for TypeScript type checking
- `make test` to run unit tests (vitest)
- `make knip` to find unused exports/files
- When deleting or renaming a source file, manually remove the corresponding `.js` file from `dist/`

## What This App Does

Electron desktop app that syncs and reconciles Girl Scout cookie sales data from **Digital Cookie** (customer-facing online sales) and **Smart Cookie** (troop management system). These are separate platforms that don't auto-sync — this app downloads from both and reconciles them.

**Smart Cookie is the source of truth** for billing, inventory, and official sales reporting. Digital Cookie is one sales channel that eventually syncs to Smart Cookie. When numbers differ, Smart Cookie is correct.

## Architecture

Three layers with strict boundaries:

**Main process** (`src/main.ts`, `src/ipc-handlers/`, `src/data-pipeline.ts`, `src/update-manager.ts`) — IPC handlers organized by domain in `ipc-handlers/`, scraper orchestration, credentials, file system, auto-updates. Owns the full data pipeline: scan files → parse → build UnifiedDataset → return to renderer.

**Renderer** (`src/renderer/`) — Preact component tree. `app.tsx` owns all state via `useReducer` (`app-reducer.ts`), passes props down. Reports in `renderer/reports/`, components in `renderer/components/`, hooks in `renderer/hooks/`. IPC wrapper in `renderer/ipc.ts`.

**Data processing** (`src/data-processing/`) — Pure functions that build a `UnifiedDataset` from raw imported data. Two-stage pipeline: **importers/** parse raw files into a `DataStore`, then **calculators/** compute the final `UnifiedDataset`.

**Scrapers** (`src/scrapers/`) — API clients for DC and SC. Session classes (`dc-session.ts`, `sc-session.ts`) own auth state with automatic re-login on 401/403 and 30-minute idle credential timeout.

### Key Files

- `src/types.ts` — All shared types (Order, Transfer, Scout, UnifiedDataset, IPC maps)
- `src/constants.ts` — Business logic constants (transfer types, categories, allocation channels)
- `src/cookie-constants.ts` — Cookie names, pricing, variety mappings across DC/SC/API
- `src/data-store.ts` — DataStore type (intermediate representation between import and calculation)
- `src/data-store-operations.ts` — Transfer/order creation with automatic category classification
- `src/order-classification.ts` — DC order type/payment/owner classification
- `src/config-manager.ts` — App config persistence and migration

### Layer Rules

- **Renderer MUST NOT import from `data-processing/`** — all data arrives via IPC as a finished UnifiedDataset. If a renderer file needs a calculation, pre-compute it in the data-processing layer or put the helper in `renderer/format-utils.ts`. Type-only imports from shared files (`types.ts`, `constants.ts`) are allowed.
- **Data-processing MUST NOT import from renderer or scrapers** — pure functions only.
- **Shared types/constants** live in `src/types.ts`, `src/constants.ts`, and `src/cookie-constants.ts`.
- **Warning propagation** — Importers detect unknowns and add warnings to `DataStore.metadata.warnings[]`. Calculators pass these through to `UnifiedDataset.metadata`. The `metadata.ts` calculator builds `HealthChecks` (counts by category). The renderer's `DataHealthChecks` component displays them in the To-Do tab.

### Conventions

- All files use **kebab-case** naming
- Constants use **`as const` objects** with derived types: `type Foo = (typeof FOO)[keyof typeof FOO]`
- Computed fields on data types use a **`$` prefix** (e.g., `$financials`, `$inventoryDisplay`, `$salesByVariety`, `$issues`)
- Business logic strings (transfer types, allocation channels, order statuses) should be **constants in `constants.ts`**, not raw strings

### BoothFinderConfig & Config Migration

The `boothFinder` key in `AppConfig` is **optional** and acts as a secret feature unlock — its presence in `config.json` enables the Booth Finder tab. The app never creates this key on its own; users must manually add it. Once present, `config-manager.ts` preserves and validates it against `BoothFinderConfig` defaults.

**Config migration** (`config-manager.ts`): On load, the config manager migrates legacy formats from v1.12/v1.13:
- **Flat booth keys** — Old top-level keys (`availableBoothsEnabled`, `autoRefreshBoothsEnabled`, etc.) are migrated into the nested `boothFinder` object.
- **Object-format arrays** — Old `DayFilter` objects migrated to `"day|startTime"` strings. Old `IgnoredTimeSlot` objects migrated to `"boothId|date|startTime"` strings.
- **Top-level key renames** — `autoUpdateEnabled` → `autoUpdate`, `autoSyncEnabled` → `autoSync`.

## Key Documentation

- **`RULES.md`** — Business rules, data classification, inventory, financials, health checks (single source of truth for how the app should behave)
- **`docs/DESIGN-PRINCIPLES.md`** — Architecture principles: classify once, positive sums, reports calculate own needs
- **`docs/DOMAIN.md`** — Cookie program domain knowledge, glossary, season reference
