# CLAUDE.md

## CRITICAL: NEVER Auto-Commit or Auto-Publish

NEVER create git commits, push, build, or publish without explicit user request. User wants full control over git history and release timing.

## Working in This Repo

- Edit `.ts`/`.tsx` files in `src/`, NEVER `.js` files in `dist/` (auto-generated by build)
- `make` to see all available commands
- `make dev` to compile and run the app
- `make compile` to compile without running
- `make format` to auto-format (biome)
- `make lint` to check formatting/lint without changes
- `make typecheck` for TypeScript type checking
- `make test` to run unit tests (vitest)
- `make knip` to find unused exports/files
- When deleting or renaming a source file, manually remove the corresponding `.js` file from `dist/`

## What This App Does

Electron desktop app that syncs and reconciles Girl Scout cookie sales data from **Digital Cookie** (customer-facing online sales) and **Smart Cookie** (troop management system). These are separate platforms that don't auto-sync — this app downloads from both and reconciles them.

**Smart Cookie is the source of truth** for billing, inventory, and official sales reporting. Digital Cookie is one sales channel that eventually syncs to Smart Cookie. When numbers differ, Smart Cookie is correct. Reports should use SC as the baseline with DC providing supplemental detail.

### Key Features

- **Data sync** — Scrapes DC (HTML/Excel) and SC (JSON API) via authenticated sessions
- **Reconciliation** — Matches orders across systems, detects discrepancies
- **Health checks** — Warns on unknown order types, payment methods, transfer types, cookie IDs (see RULES.md)
- **13 reports in 5 tab groups + To-Do** — To-Do (Health Check, standalone button), Troop (Inventory & Transfers, Online Orders, Proceeds, plus Inventory History when enabled), Scout (Sales Summary, Inventory, Cash Report), Booths (Completed, Upcoming, plus Booth Finder when enabled), Donations, Cookie Popularity
- **Profile management** — Import, switch, and delete data profiles for managing multiple troops
- **Auto-updates** — Silent download via electron-updater, non-blocking restart banner

## How the Code Is Organized

Three layers with strict boundaries:

**Main process** (`src/main.ts`, `src/data-pipeline.ts`, `src/update-manager.ts`) — IPC handlers, scraper orchestration, credentials, file system, auto-updates. Owns the full data pipeline: scan files, parse, build UnifiedDataset, return to renderer.

**Renderer** (`src/renderer/`) — Preact component tree. `app.tsx` owns all state via `useReducer` (see `app-reducer.ts`), passes props down. Reports in `renderer/reports/` (13 report components, one per file). Components in `renderer/components/`, hooks in `renderer/hooks/`. Settings and Sync are rendered as tab content (via `activeReport`), not separate pages — only "welcome" mode uses a dedicated `activePage`. IPC wrapper in `renderer/ipc.ts`, data loading in `renderer/data-loader.ts`, formatting utilities in `renderer/format-utils.ts`.

**Data processing** (`src/data-processing/`) — Pure functions that build a `UnifiedDataset` from raw imported data. Sub-directories: `importers/` (parse raw files into DataStore), `calculators/` (compute UnifiedDataset from DataStore).

**Scrapers** (`src/scrapers/`) — API clients for DC and SC. Each scraper has a separate session class (`dc-session.ts`, `sc-session.ts`) that owns auth state, with automatic re-login on 401/403.

### Key Source Files

| File | Purpose |
|---|---|
| `src/types.ts` | All shared types (Order, Transfer, Scout, UnifiedDataset, IPC maps) |
| `src/constants.ts` | Business logic constants (transfer types, categories, allocation channels) |
| `src/cookie-constants.ts` | Cookie names, pricing, variety mappings across DC/SC/API |
| `src/data-store.ts` | DataStore creation and type — intermediate store between import and calculation |
| `src/data-store-operations.ts` | Transfer/order creation, classification (`classifyTransferCategory`, `matchesTroopNumber`) |
| `src/order-classification.ts` | DC order type/payment/owner classification |
| `src/validators.ts` | Input validation for credentials and config |
| `src/config-manager.ts` | App configuration persistence (booth IDs, filters) |
| `src/credentials-manager.ts` | Encrypted credential storage |
| `src/seasonal-data.ts` | Persists SC session data (troop info, cookie ID map) across syncs |
| `src/data-pipeline.ts` | Orchestrates: scan files, import, build UnifiedDataset |
| `src/update-manager.ts` | Auto-update configuration, event handlers, quit-and-install logic |
| `src/data-processing/utils.ts` | Shared helpers for data-processing layer (`mapToRecord`) |
| `src/profile-manager.ts` | Multi-profile data directory management |

### Renderer Components

| Component | Purpose |
|---|---|
| `reports-section.tsx` | TabBar + ReportContent components, health banner, report rendering |
| `sync-section.tsx` | Sync state utilities (`createInitialSyncState`, `computeGroupStatuses`), SyncStatusSection, DataHealthChecks |
| `settings-page.tsx` | Credential setup (SettingsPage), app toggle switches + profile management + import modal (SettingsToggles) |
| `booth-selector.tsx` | Multi-select UI for choosing booth locations to track |
| `booth-day-filter.tsx` | Day/time filter configuration for Available Booths report |
| `scout-detail.tsx` | Expandable scout detail panel (orders, inventory, allocations) |
| `data-table.tsx` | Reusable sortable table component |
| `stat-cards.tsx` | Reusable stat card grid component |
| `expandable-row.tsx` | Expandable/collapsible table row component |
| `tooltip-cell.tsx` | Tooltip component for table cells |
| `scout-credit-chips.tsx` | Shared chip display for per-scout allocation breakdowns |

### Layer Rules

- **Renderer MUST NOT import from `data-processing/`** — all data arrives via IPC as a finished UnifiedDataset. If a renderer file needs a calculation, either pre-compute it in the data-processing layer or put the helper in `renderer/format-utils.ts`. Type-only imports from shared files (`types.ts`, `constants.ts`) are allowed.
- **Data-processing MUST NOT import from renderer or scrapers** — it's pure functions operating on data.
- **Shared types/constants** live in `src/types.ts`, `src/constants.ts`, and `src/cookie-constants.ts` (cookie names, pricing, variety mappings) — both layers import from these.
- **Seasonal data** (`src/seasonal-data.ts`) — Persists SC session data (troop info, cookie ID map) across syncs so the pipeline knows troop identity before importing orders.

### Conventions

- All files use **kebab-case** naming
- Constants use **`as const` objects** with derived types: `type Foo = (typeof FOO)[keyof typeof FOO]`
- Computed fields on data types use a **`$` prefix** (e.g., `$financials`, `$orderStatusCounts`, `$issues`) to distinguish them from raw data fields
- Business logic strings (transfer types, allocation channels, order statuses) should be **constants in `constants.ts`**, not raw strings

## Key Documentation

- **`RULES.md`** — Business rules, data classification, inventory, financials, health checks (single source of truth for how the app should behave)
- **`docs/DESIGN-PRINCIPLES.md`** — Architecture principles: classify once, positive sums, reports calculate own needs
- **`docs/DOMAIN.md`** — Cookie program domain knowledge, data format reference, scraper authentication, glossary
- **`docs/DISTRIBUTION-UPDATES.md`** — Build, version, and release procedures
