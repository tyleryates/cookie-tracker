# CLAUDE.md

## CRITICAL: NEVER Auto-Commit or Auto-Publish

NEVER create git commits, push, build, or publish without explicit user request. User wants full control over git history and release timing.

## Working in This Repo

- Edit `.ts`/`.tsx` files in `src/`, NEVER `.js` files in `dist/` (auto-generated by build)
- `make` to see all available commands
- `make dev` to compile and run the app
- `make compile` to compile without running
- `make format` to auto-format (biome)
- `make lint` to check formatting/lint without changes
- `make typecheck` for TypeScript type checking
- `make test` to run unit tests (vitest)
- `make knip` to find unused exports/files
- When deleting or renaming a source file, manually remove the corresponding `.js` file from `dist/`

## What This App Does

Electron desktop app that syncs and reconciles Girl Scout cookie sales data from **Digital Cookie** (customer-facing online sales) and **Smart Cookie** (troop management system). These are separate platforms that don't auto-sync — this app downloads from both and reconciles them.

**Smart Cookie is the source of truth** for billing, inventory, and official sales reporting. Digital Cookie is one sales channel that eventually syncs to Smart Cookie. When numbers differ, Smart Cookie is correct. Reports should use SC as the baseline with DC providing supplemental detail.

## How the Code Is Organized

Three layers with strict boundaries:

**Main process** (`src/main.ts`, `src/data-pipeline.ts`) — IPC handlers, scraper orchestration, credentials, file system. Owns the full data pipeline: scan files, parse, build UnifiedDataset, return to renderer.

**Renderer** (`src/renderer/`) — Preact component tree. `app.tsx` owns all state via `useReducer` (see `app-reducer.ts`), passes props down. Reports are in `renderer/reports/`, components in `renderer/components/`.

**Data processing** (`src/data-processing/`) — Pure functions that build a `UnifiedDataset` from raw imported data. Sub-directories: `importers/` (parse raw files into DataStore), `calculators/` (compute UnifiedDataset from DataStore).

**Scrapers** (`src/scrapers/`) — API clients for DC and SC. Each scraper has a separate session class (`dc-session.ts`, `sc-session.ts`) that owns auth state.

### Layer Rules

- **Renderer MUST NOT import from `data-processing/`** — all data arrives via IPC as a finished UnifiedDataset. If a renderer file needs a calculation, either pre-compute it in the data-processing layer or put the helper in `renderer/format-utils.ts`.
- **Data-processing MUST NOT import from renderer or scrapers** — it's pure functions operating on data.
- **Shared types/constants** live in `src/types.ts` and `src/constants.ts` — both layers import from these.

### Conventions

- All files use **kebab-case** naming
- Constants use **`as const` objects** with derived types: `type Foo = (typeof FOO)[keyof typeof FOO]`
- Computed fields on data types use a **`$` prefix** (e.g., `$financials`, `$orderStatusCounts`, `$issues`) to distinguish them from raw data fields
- Business logic strings (transfer types, allocation channels, order statuses) should be **constants in `constants.ts`**, not raw strings

## Key Documentation

- **`RULES.md`** — Business rules, data classification, inventory, financials (single source of truth for how the app should behave)
- **`docs/DESIGN-PRINCIPLES.md`** — Architecture principles: classify once, positive sums, reports calculate own needs
- **`docs/DOMAIN.md`** — Cookie program domain knowledge, data format reference, scraper authentication, glossary
- **`docs/DISTRIBUTION-UPDATES.md`** — Build, version, and release procedures
