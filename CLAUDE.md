# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## ğŸš« CRITICAL: NEVER Auto-Commit or Auto-Publish

**BLOCKING REQUIREMENT - Always require explicit user approval:**

- âŒ NEVER create git commits without explicit user request
- âŒ NEVER publish/release versions without explicit user approval
- âŒ NEVER run `git commit`, `git push`, `npm run build`, or `electron-builder` commands proactively
- âœ… User must explicitly ask "commit this" or "publish version X.Y.Z" before taking action
- âœ… If user asks to "release" or "publish", confirm version number and changes before proceeding

**Why:** User wants full control over git history and release timing.

## TypeScript: Edit src/*.ts files, NEVER dist/*.js files

Source code lives in `src/`, compiled output goes to `dist/`. The `.js` files in `dist/` are auto-generated by `npx tsc`.

- **ALWAYS edit `.ts` files in `src/`**, then compile with `npm run compile`
- **NEVER edit `.js` files in `dist/`** â€” changes will be overwritten by the compiler
- `npm run compile` runs `tsc` and copies static assets (`index.html`, `styles.css`) to `dist/`

## Project Overview

Girl Scout Cookie Tracker - An Electron desktop app that syncs and reconciles cookie sales data from two independent systems:
- **Digital Cookie**: Customer-facing online sales platform (API-based sync)
- **Smart Cookie**: Troop management system (API-based sync)

These systems don't auto-sync and track sales from different perspectives, requiring manual reconciliation.

### âš ï¸ CRITICAL: Data Source Hierarchy

**Smart Cookie is the SOURCE OF TRUTH** for all cookie program operations:
- âœ… **All billing and financial tracking** - Smart Cookie handles all money/payments
- âœ… **All inventory management** - C2T pickups, T2G allocations, actual inventory levels
- âœ… **Official sales reporting** - "Total Sold" that matters for council/troop
- âœ… **Troop and scout financial records** - What determines proceeds and rewards

**Digital Cookie is SUPPLEMENTAL information:**
- ğŸ“± One electronic sales channel (online orders, Girl Links, etc.)
- ğŸ“ Can have orders manually entered (not just automatic)
- ğŸ”„ Data eventually syncs TO Smart Cookie (DC â†’ SC, not the other way)
- ğŸ“Š Provides customer details, order breakdown, and additional context

**Application Design Principle:**
- Primary focus: Smart Cookie data (inventory, T2G allocations, total sold)
- Secondary focus: Digital Cookie data (order details, customer info, variety breakdown)
- Reports should use Smart Cookie as the baseline with DC providing supplemental detail
- When numbers differ, Smart Cookie is correct for billing/financial purposes

## Development Commands

```bash
# View all available commands
make

# Development
make install            # Install dependencies
make dev                # Start the application

# Building
make build              # macOS DMG
make build-win          # Windows NSIS
make build-all          # Both platforms

# Versioning & Release
make bump-patch         # Bump patch version (1.0.0 â†’ 1.0.1)
make release-patch      # Bump, commit, build, and publish

# Or use npm directly
npm start               # Start app
npm run build           # Build for current platform
```

## Architecture

### Tech Stack
- **Electron** - Desktop app (src/main.ts = main process, src/renderer.ts = renderer process)
- **Axios** - HTTP client for both Digital Cookie and Smart Cookie APIs
- **axios-cookiejar-support** + **tough-cookie** - Cookie management for API requests
- **cheerio** - HTML parsing (Digital Cookie CSRF token extraction)
- **XLSX** - Excel file parsing and export
- **Tippy.js** - Interactive tooltips
- **electron-updater** - Auto-update functionality (optional)

**Note**: Both scrapers use direct API calls (no browser automation needed).

### Core Components

**src/main.ts** - Electron main process, IPC handlers, window management

**src/renderer.ts** - UI logic, report generation, data display

**src/data-reconciler.ts** - Data normalization, deduplication, and transfer creation
- Creates transfers with explicit `TRANSFER_CATEGORY` via `classifyTransferCategory()`
- Deduplicates orders by order number (handles DC "229584475" vs SC "D229584475")

**src/data-processing/calculators/** - Unified dataset computation (modular)
- Scout processing (5 phases): initialize â†’ orders â†’ inventory â†’ allocations â†’ totals
- Troop-level: package totals, troop totals, varieties, transfer breakdowns
- Reconciliation: cookie share tracking, site orders, metadata/health checks

**src/scrapers/index.ts** - Orchestrator for both scrapers (DC and SC run in parallel)

**src/scrapers/digital-cookie.ts** - API client for Digital Cookie
- CSRF token extraction â†’ form POST login â†’ role selection â†’ report download
- Fast, no browser required

**src/scrapers/smart-cookie.ts** - API client for Smart Cookie
- Login â†’ extract XSRF token â†’ call /me endpoint â†’ initialize orders context â†’ call orders/search API â†’ save JSON
- Fast, no browser required
- **Key detail**: XSRF token has format `part1|part2` where `|` is URL-encoded as `%7C` in cookies

**src/credentials-manager.ts** - Encrypted credential storage using Electron safeStorage API (OS keychain)

### Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Digital Cookie   â”‚â”€â”€â”€â”€ Excel â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚     â”‚ Calculators    â”‚
â”‚ (API)            â”‚                     â”‚ Reconciler     â”‚â”€â”€â”€â”€â–¶â”‚ (13 modules)   â”‚â”€â”€â–¶ Unified Dataset
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚                â”‚     â”‚                â”‚
                                         â”‚ - Normalize    â”‚     â”‚ - Scouts       â”‚    â”œâ”€ scouts (Map)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚ - Deduplicate  â”‚     â”‚ - Troop totals â”‚    â”œâ”€ troopTotals
â”‚ Smart Cookie     â”‚â”€â”€â”€â”€ JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ - Classify     â”‚     â”‚ - Varieties    â”‚    â”œâ”€ varieties
â”‚ (API)            â”‚                     â”‚   transfers    â”‚     â”‚ - Cookie share â”‚    â”œâ”€ cookieShare
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€ metadata
```

### Data Storage

**Production (packaged app):**
- macOS: `~/Library/Application Support/Cookie Tracker/data/` (uses `productName` from package.json)
- Windows: `%APPDATA%/Cookie Tracker/data/`

**Development (`npm start`):**
- macOS: `~/Library/Application Support/cookie-tracker/data/` (uses `name` from package.json)
- Windows: `%APPDATA%/cookie-tracker/data/`

**Files:**
```
data/
  credentials.enc         # Encrypted credentials (OS keychain)
  DC-YYYY-MM-DD-HH-MM-SS.xlsx      # Digital Cookie API downloads
  SC-YYYY-MM-DD-HH-MM-SS.json      # Smart Cookie API data
```

## Key Domain Concepts

### Order Number Formats
- **Digital Cookie**: `229584475` (9-digit numeric, no prefix)
- **Smart Cookie Transfer**: `D229584475` (same order with D prefix)
- **Smart Cookie Report**: `229584475` (matches DC exactly)

When matching orders, strip the `D` prefix from SC transfer order numbers.

### Special Order Types

**"Site" Orders** - Troop booth sales (NOT individual girl sales)
- Last Name = "Site"
- First Name = "Troop XXXX" (troop number)
- Must be filtered OUT for per-girl reports
- Must be included for troop totals

**Cookie Share** - Donation orders where cookies go to military
- Girl collects money but doesn't handle cookies
- Appears in both systems with different formats
- Type includes "with Donation" or just "Donation"

### Transfer Types (Smart Cookie)
- `C2T` / `C2T(P)` / `T2T` - Council/Troop to Troop (inventory IN)
- `T2G` - Troop to Girl (scout pickup) - inventory OUT
- `G2T` - Girl to Troop (return) - inventory IN
- `D` - DC order synced to SC (sync record)
- `COOKIE_SHARE` / `COOKIE_SHARE_D` - Donation package sale (manual or DC-synced)
- `DIRECT_SHIP` - Shipped order (may have S prefix)
- `PLANNED` - Future/uncommitted order

All OUT transactions have negative quantities in SC data - use `Math.abs()` for display.

### Data Quality Issues

**Expected behavior:**
- Only 10-15% of DC orders appear in SC transfers (this is normal, not a bug)
- Orders are "pending" in SC until council approves and syncs them
- Scout names may differ in format: "Charlie Yates" vs "Yates, Charlie"

**Boolean gotchas:**
- SC Report fields like `CShareVirtual` are strings: `"TRUE"`/`"FALSE"`, not booleans
- `IncludedInIO` is `"Y"` or `"N"`, not boolean

**Date formats:**
- DC uses Excel serial dates: `46053.55347222222` (days since 1900-01-01)
- SC Report uses strings: `"01/25/2026 11:20:42 AM"`
- SC Transfers use short dates: `"01/28/2026"`

**Cases/Packages format:**
- SC Reports use `"cases/packages"`: `"0/8"` or `"2/5"`
- Calculate total: `(cases Ã— 12) + packages`
- Most other data uses total packages only

## Reconciliation Logic

The `DataReconciler` class (`src/data-reconciler.ts`) manages state and creates transfers (including `classifyTransferCategory()`). The `data-processing/calculators/` modules build the unified dataset in five phases:

1. **Import & Normalize** â€” `data-importers.ts` parses DC Excel, SC JSON/API, SC Report formats
2. **Order Deduplication** â€” Merge orders by order number (DC `229584475` = SC `D229584475`)
3. **Scout Processing** (five phases in `calculators/`):
   - Initialize scouts â†’ Add DC orders â†’ Add T2G inventory â†’ Add divider allocations â†’ Calculate totals
4. **Troop Aggregation** â€” Package totals, troop inventory, proceeds, variety breakdowns
5. **Unified Dataset** â€” scouts, troopTotals, varieties, cookieShare, boothReservations, metadata

## Design Principles

**CRITICAL:** Before making changes, read [`docs/DESIGN-PRINCIPLES.md`](docs/DESIGN-PRINCIPLES.md)

Key principles (see that file for examples, decision tree, and code review checklist):

1. **Model what data IS, not how reports USE it** â€” Data models contain fundamental properties (`transfer.category`, `order.needsInventory`), not report-specific aggregations. Reports calculate their own breakdowns from clean data.
2. **Classify once, use everywhere** â€” `classifyTransferCategory()` assigns a `TRANSFER_CATEGORY` at creation time. Reports dispatch on `transfer.category`, never re-derive from raw fields.
3. **Reports calculate their own needs** â€” Simple loops over classified data, co-located with display code.
4. **Classify granularly, report with simple sums** â€” `report.value = sum(items.where(category == X).field)`. No subtraction patterns, no remainder classification, no derived-from-derived.
5. **Central category group sets** â€” `T2G_CATEGORIES`, `TROOP_INVENTORY_IN_CATEGORIES`, `SCOUT_PHYSICAL_CATEGORIES` in `constants.ts`. Update once, all consumers pick up the change.

---

## Important Patterns

### CSRF Token Extraction (Digital Cookie)
Digital Cookie requires a CSRF token from the login page before submitting credentials. Extract from HTML: `<input name="_requestConfirmationToken" value="..." />`

### Smart Cookie API Flow
Smart Cookie uses direct API calls (no browser needed):
1. **Login**: POST to `/webapi/api/account/login` with credentials
2. **Extract XSRF Token**: Get from `XSRF-TOKEN` cookie, URL-decode if contains `%7C`
   - Token format: `part1|part2` (pipe may be URL-encoded as `%7C`)
   - CRITICAL: Must decode `%7C` to `|` for authentication to work
3. **Establish Session**: GET `/webapi/api/me` to initialize session
4. **Initialize Orders Context**: GET `/webapi/api/orders/dashboard`
5. **Fetch Orders**: POST to `/webapi/api/orders/search` with XSRF token in `x-xsrf-token` header

### Role Selection (Digital Cookie)
- **Auto-selection**: If no role is specified in credentials, automatically selects the first role that starts with "Troop"
- **Manual selection**: If a role is specified, matches exactly as before
- After selection, the role name contains embedded IDs: "Troop **1234** of Service Unit **567**" (example)
  - Extract `troopId` with regex: `/Troop (\d+)/`
  - Extract `serviceUnitId` with regex: `/Service Unit (\d+)/`
  - These IDs are required for the report download API

### Troop Number Detection (Smart Cookie)
- Troop number automatically detected from C2T (Council to Troop) transfers
- No manual configuration needed
- Used for distinguishing troop transfers from scout transfers

### Progress Callbacks
Both scrapers accept a progress callback that reports status updates (0-100%) to the UI. Always send progress updates at key milestones.

### Adding a New Report

1. Create `src/renderer/reports/my-report.ts` with a `generateMyReport(reconciler)` function
2. Add import and `REPORT_CONFIG` entry in `src/renderer.ts`
3. Add button to `src/index.html`
4. Wire click handler in `src/renderer/ui-controller.ts`
5. Enable/disable in `enableReportButtons()` in `src/renderer.ts`

Reports read from `reconciler.unified` (pre-computed data) and return HTML strings. Use `html-builder.ts` helpers for consistent tables and stat cards.

## Common Pitfalls

1. **Don't panic about missing SC orders** - Only 10-15% of DC orders appear in SC transfers initially. This is expected.

2. **Filter "Site" orders for girl reports** - Troop booth sales (last name "Site") should not be included in per-girl summaries.

3. **Handle D prefix in SC transfers** - Order numbers in SC transfers have a D prefix; strip it before matching with DC orders.

4. **Negative quantities in SC** - All SC transfer OUT quantities are negative. Use `Math.abs()` for display.

5. **String booleans in SC Reports** - Fields like `CShareVirtual` are `"TRUE"`/`"FALSE"` strings, not actual booleans.

6. **Excel date conversion** - DC dates are Excel serial numbers, not ISO strings. Convert using: `new Date((excelDate - 25569) * 86400000)`.

## Documentation

### Start Here
1. **`RULES.md`** - All business rules, data classification, inventory, financials, edge cases (single authoritative source)
2. **`docs/IMPLEMENTATION-NOTES.md`** - Code patterns, data model, reconciliation pipeline, data format reference

### Reference
- **`docs/DESIGN-PRINCIPLES.md`** - Architecture principles: model what data IS, classify once, reports calculate own needs
- **`docs/SYSTEM-OVERVIEW.md`** - Girl Scout Cookie domain knowledge, glossary, GSSD reconciliation requirements
- **`docs/PROGRAM-KNOWLEDGE.md`** - Operational reference for the 2026 cookie program (timeline, roles, procedures, Q&A)
- **`docs/DISTRIBUTION-UPDATES.md`** - How to build and distribute updates to users

### Development
- **`Makefile`** - Helper commands (run `make` to see all)
- **`README.md`** - Project overview, quick start, features
